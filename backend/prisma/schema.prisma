generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model UserNotificationSettings {
  id                       String   @id @default(cuid())
  userId                   String   @unique
  notifyOnSupportChatReply Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notification_settings")
}

model UserNotification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // support_chat | order_status | system
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_notifications")
}

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  password          String
  firstName         String?
  lastName          String?
  role              UserRole       @default(USER)
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  avatar            String?
  phone             String?
  notificationSettings UserNotificationSettings?
  notificationHistory  UserNotification[]
  adminNotificationOverride UserAdminNotificationOverride?
  addresses         Address[]
  blogPosts         BlogPost[]
  cartItems         CartItem[]
  comments          Comment[]
  assignedCustomers Customer[]     @relation("ManagerCustomers")
  interactions      Interaction[]
  orders            Order[]
  salesMetrics      SalesMetric[]
  tasks             Task[]         @relation("AssignedTasks")
  createdTasks      Task[]         @relation("CreatedTasks")
  wishlist          WishlistItem[]
  compareItems      CompareItem[]
  supportConversations       SupportConversation[] @relation("SupportUser")
  assignedSupportConversations SupportConversation[] @relation("SupportAgent")
  supportMessages   SupportMessage[]
  managedMeasurements   Measurement[] @relation("MeasurementManager")
  surveyedMeasurements  Measurement[] @relation("MeasurementSurveyor")
  managedContracts      Contract[]    @relation("ContractManager")
  surveyedContracts     Contract[]    @relation("ContractSurveyor")
  contractPayments      ContractPayment[]
  measurementHistory    MeasurementHistory[] @relation("MeasurementHistoryChangedBy")
  contractHistory     ContractHistory[]    @relation("ContractHistoryChangedBy")

  @@map("users")
}

model SupportConversation {
  id           String              @id @default(cuid())
  userId       String
  assignedToId String?
  status       ConversationStatus  @default(OPEN)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation("SupportUser", fields: [userId], references: [id], onDelete: Cascade)
  assignedTo   User?               @relation("SupportAgent", fields: [assignedToId], references: [id], onDelete: SetNull)
  messages     SupportMessage[]

  @@map("support_conversations")
}

model SupportMessage {
  id             String             @id @default(cuid())
  conversationId String
  senderId       String
  content        String             @db.Text
  createdAt      DateTime           @default(now())
  conversation   SupportConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User               @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@map("support_messages")
}

model HomeDirectionImage {
  id       String   @id @default(cuid())
  slug     String   @unique
  imageUrl String
  updatedAt DateTime @updatedAt

  @@map("home_direction_images")
}

model HeroBlock {
  id            String   @id @default("main")
  titleMain     String   @default("Создаем интерьеры мечты")
  titleAccent   String   @default("в Мурманске")
  subtitle      String   @default("Мебель на заказ, ремонт под ключ, двери входные и межкомнатные, натяжные потолки, жалюзи, мягкая мебель, кровати, матрасы .....") @db.Text
  slideShowMode String   @default("auto") // auto | manual | static
  slideGap      Int      @default(16) // зазор между фотографиями в слайдере (px)
  updatedAt     DateTime @updatedAt

  @@map("hero_block")
}

model HeroSlide {
  id        String   @id @default(cuid())
  imageUrl  String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  @@map("hero_slides")
}

model HeroFeature {
  id        String   @id @default(cuid())
  icon      String
  title     String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  @@map("hero_features")
}

model AdvantagesBlock {
  id        String   @id @default("main")
  title     String   @default("Почему выбирают нас")
  subtitle  String   @default("Мы делаем качество доступным")
  updatedAt DateTime @updatedAt

  @@map("advantages_block")
}

model AdvantageItem {
  id          String   @id @default(cuid())
  icon        String
  title       String
  description String   @db.Text
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  @@map("advantage_items")
}

model ServicesBlock {
  id        String   @id @default("main")
  title     String   @default("Комплексные решения")
  subtitle  String   @default("Полный цикл услуг для вашего комфорта")
  updatedAt DateTime @updatedAt

  @@map("services_block")
}

model FeaturedProductsBlock {
  id             String   @id @default("main")
  title          String   @default("Популярные товары")
  subtitle       String   @default("Товары, которые выбирают наши клиенты")
  limit          Int      @default(8)
  primaryFilter  String   @default("featured") // featured | new | featured_or_new | any
  secondaryOrder String   @default("sort_order") // sort_order | created_desc
  updatedAt      DateTime @updatedAt

  @@map("featured_products_block")
}

model HomePageSectionsBlock {
  id                    String   @id @default("main")
  heroVisible           Boolean  @default(true)
  directionsVisible     Boolean  @default(true)
  advantagesVisible     Boolean  @default(true)
  servicesVisible       Boolean  @default(true)
  featuredProductsVisible Boolean @default(true)
  contactFormVisible    Boolean  @default(true)
  updatedAt             DateTime @updatedAt

  @@map("home_page_sections_block")
}

model ContactFormBlock {
  id                 String   @id @default("main")
  title              String   @default("Готовы начать проект?")
  subtitle           String   @default("Оставьте заявку и получите бесплатную консультацию специалиста") @db.Text
  backgroundImage    String?  // URL или путь к фоновой картинке
  backgroundOpacity  Float?   // Прозрачность фона 0–1 (null = 0.5)
  updatedAt          DateTime @updatedAt

  @@map("contact_form_block")
}

model Partner {
  id                 String   @id @default(cuid())
  name               String   // Название партнёра
  logoUrl            String?  // URL логотипа (для карточек товаров)
  showLogoOnCards    Boolean  @default(true) // Показывать логотип на карточках товаров
  tooltipText        String?  // Текст всплывающей подсказки при наведении на логотип (если пусто — "Товар Партнёра : название")
  showTooltip        Boolean  @default(true) // Показывать всплывающую подсказку при наведении на логотип
  website            String?
  email              String?
  phone              String[] @default([])
  description        String?  @db.Text
  isActive           Boolean  @default(true)
  sortOrder          Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  products           Product[]

  @@map("partners")
}

model PartnerProductsBlock {
  id                    String   @id @default("main")
  partnerLogoUrl        String?  // URL логотипа партнёра по умолчанию (в кружке на карточках)
  showPartnerIconOnCards Boolean @default(true) // Показывать иконку партнёра на карточках товаров
  updatedAt             DateTime @updatedAt

  @@map("partner_products_block")
}

model FooterBlock {
  id                    String   @id @default("main")
  workingHoursWeekdays  String   @default("пн-пт: 11-19")
  workingHoursSaturday  String   @default("сб: 12-16")
  workingHoursSunday    String   @default("вс: выходной")
  phone                 String   @default("8 (8152) 60-12-70")
  email                 String   @default("skvirya@mail.ru")
  developer             String   @default("ИП Сквиря Р.В.")
  copyrightCompanyName  String   @default("Территория интерьерных решений")
  vkHref                String   @default("https://vk.com/pskpobeda")
  vkIcon                String   @default("/images/icons-vk.png")
  updatedAt             DateTime @updatedAt

  @@map("footer_block")
}

model FooterSection {
  id        String   @id @default(cuid())
  title     String
  sortOrder Int      @default(0)
  links     FooterSectionLink[]

  @@map("footer_sections")
}

model FooterSectionLink {
  id        String        @id @default(cuid())
  sectionId String
  name      String
  href      String
  sortOrder Int           @default(0)
  section   FooterSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@map("footer_section_links")
}

model NavigationItem {
  id             String                    @id @default(cuid())
  name           String
  href           String                    @default("#")
  sortOrder      Int                       @default(0)
  hasDropdown    Boolean                   @default(false)
  isActive       Boolean                   @default(true)
  dropdownItems  NavigationDropdownItem[]

  @@map("navigation_items")
}

model NavigationDropdownItem {
  id        String                         @id @default(cuid())
  navItemId String
  name      String
  href      String                         @default("#")
  sortOrder Int                            @default(0)
  icon      String?                        // имя иконки heroicons или URL
  navItem   NavigationItem                @relation(fields: [navItemId], references: [id], onDelete: Cascade)
  submenu   NavigationDropdownSubItem[]

  @@map("navigation_dropdown_items")
}

model NavigationDropdownSubItem {
  id          String                  @id @default(cuid())
  dropdownId  String
  name        String
  href        String                  @default("#")
  sortOrder   Int                     @default(0)
  dropdownItem NavigationDropdownItem @relation(fields: [dropdownId], references: [id], onDelete: Cascade)

  @@map("navigation_dropdown_sub_items")
}

model ServiceItem {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  features    String[]
  price       String
  imageUrl    String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  @@map("service_items")
}

model Customer {
  id            String         @id @default(cuid())
  email         String         @unique
  phone         String?
  firstName     String
  lastName      String?
  company       String?
  position      String?
  source        LeadSource     @default(WEBSITE)
  status        CustomerStatus @default(LEAD)
  stage         DealStage      @default(NEW)
  dealValue     Decimal?       @db.Decimal(12, 2)
  notes         String?
  tags          String[]
  managerId     String?
  isActive      Boolean        @default(true)
  lastContactAt DateTime?
  nextFollowUp  DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  manager       User?          @relation("ManagerCustomers", fields: [managerId], references: [id])
  deals         Deal[]
  interactions  Interaction[]
  tasks         Task[]
  measurements  Measurement[]
  contracts     Contract[]

  @@map("customers")
}

model Interaction {
  id          String          @id @default(cuid())
  customerId  String
  userId      String
  type        InteractionType
  subject     String?
  description String?
  outcome     String?
  createdAt   DateTime        @default(now())
  customer    Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id])

  @@map("interactions")
}

model Deal {
  id                String    @id @default(cuid())
  customerId        String
  title             String
  value             Decimal   @db.Decimal(12, 2)
  stage             DealStage @default(NEW)
  probability       Int       @default(0)
  expectedCloseDate DateTime?
  closedAt          DateTime?
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  customer          Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("deals")
}

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?
  type        TaskType     @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(PENDING)
  dueDate     DateTime?
  completedAt DateTime?
  customerId  String?
  assigneeId  String?
  createdById String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  assignee    User?        @relation("AssignedTasks", fields: [assigneeId], references: [id])
  createdBy   User         @relation("CreatedTasks", fields: [createdById], references: [id])
  customer    Customer?    @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

model Page {
  id             String     @id @default(cuid())
  title          String
  slug           String     @unique
  content        String
  excerpt        String?
  featuredImage  String?
  template       String     @default("default")
  status         PageStatus @default(DRAFT)
  publishedAt    DateTime?
  seoTitle       String?
  seoDescription String?
  seoKeywords    String[]
  parentId       String?
  order          Int        @default(0)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  parent         Page?      @relation("PageTree", fields: [parentId], references: [id])
  children       Page[]     @relation("PageTree")

  @@map("pages")
}

model BlogPost {
  id             String         @id @default(cuid())
  title          String
  slug           String         @unique
  content        String
  excerpt        String?
  featuredImage  String?
  status         PageStatus     @default(DRAFT)
  publishedAt    DateTime?
  authorId       String
  categoryId     String?
  tags           String[]
  viewCount      Int            @default(0)
  seoTitle       String?
  seoDescription String?
  allowComments  Boolean        @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  author         User           @relation(fields: [authorId], references: [id])
  category       BlogCategory?  @relation(fields: [categoryId], references: [id])
  comments       Comment[]
  likes          BlogPostLike[]

  @@map("blog_posts")
}

model BlogPostLike {
  id        String   @id @default(cuid())
  postId    String
  likerId   String   // userId или "g_" + guestUuid
  createdAt DateTime @default(now())
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, likerId])
  @@index([postId])
  @@map("blog_post_likes")
}

model BlogCategory {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  image       String?
  order       Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  posts       BlogPost[]

  @@map("blog_categories")
}

model PhotoCategory {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique
  description String?
  image       String?
  order       Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  projects    PhotoProject[]

  @@map("photo_categories")
}

model PhotoProject {
  id          String        @id @default(cuid())
  categoryId  String
  title       String        // Название объекта (например "Квартира ул. Ленина 15")
  description String?       @db.Text // Описание выполненных работ
  displayMode String        @default("grid") // grid | masonry | slider
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  category    PhotoCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  photos      Photo[]

  @@map("photo_projects")
}

model Photo {
  id         String       @id @default(cuid())
  projectId  String
  imageUrl   String
  sortOrder  Int          @default(0)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  project    PhotoProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("photos")
}

model Promotion {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  imageUrl    String
  description String?  @db.Text
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("promotions")
}

model Comment {
  id          String        @id @default(cuid())
  postId      String
  authorId    String?
  authorName  String?
  authorEmail String?
  content     String
  status      CommentStatus @default(PENDING)
  parentId    String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  author      User?         @relation(fields: [authorId], references: [id])
  parent      Comment?      @relation("CommentTree", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[]     @relation("CommentTree")
  post        BlogPost      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model Manufacturer {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  logo        String?
  website     String?
  country     String?
  isActive    Boolean   @default(true)
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@map("manufacturers")
}

model Attribute {
  id           String              @id @default(cuid())
  name         String
  slug         String              @unique
  type         AttributeType       @default(TEXT)
  unit         String?
  isFilterable Boolean             @default(true)
  isRequired   Boolean             @default(false)
  order        Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  values       AttributeValue[]
  categories   CategoryAttribute[]

  @@map("attributes")
}

model AttributeValue {
  id          String    @id @default(cuid())
  attributeId String
  value       String
  colorHex    String?
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  attribute   Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@map("attribute_values")
}

model Supplier {
  id              String            @id @default(cuid())
  name            String?           // Для обратной совместимости
  legalName       String            // Наименование юридическое (обязательное)
  commercialName  String?           // Наименование коммерческое
  email           String?
  phone           String[]          @default([]) // Массив телефонов
  website         String?           // Адрес сайта
  legalAddress    String?           // Юридический адрес
  inn             String?           @unique // ИНН (уникальный)
  bankName        String?           // Банк
  bankAccount     String?           // Расчетный счет (р/сч)
  bankBik         String?           // БИК
  apiUrl          String?
  apiKey          String?
  priceMarkup     Decimal           @default(0) @db.Decimal(5, 2)
  isActive        Boolean           @default(true)
  syncEnabled     Boolean           @default(false)
  syncSchedule    String?
  lastSyncAt      DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  products        ProductSupplier[]
  syncLogs        SupplierSyncLog[]

  @@map("suppliers")
}

model ProductSupplier {
  id                     String    @id @default(cuid())
  productId              String
  supplierId             String
  supplierSku            String
  supplierPrice          Decimal   @db.Decimal(10, 2)
  supplierStock         Int       @default(0)
  supplierProductUrl    String?   // Ссылка на товар у поставщика
  supplierPriceChangedAt DateTime? // Пометка: цена поставщика изменилась при последней синхронизации
  isMainSupplier        Boolean   @default(false)
  lastSyncAt            DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  product               Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier              Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([productId, supplierId])
  @@map("product_suppliers")
}

model SupplierSyncLog {
  id              String     @id @default(cuid())
  supplierId      String
  status          SyncStatus
  productsAdded   Int        @default(0)
  productsUpdated Int        @default(0)
  productsRemoved Int        @default(0)
  errors          String?
  startedAt       DateTime   @default(now())
  completedAt     DateTime?
  supplier        Supplier   @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@map("supplier_sync_logs")
}

model ShippingMethod {
  id              String   @id @default(cuid())
  name            String
  code            String   @unique
  description     String?
  price           Decimal  @db.Decimal(10, 2)
  freeFromAmount  Decimal? @db.Decimal(10, 2)
  minDeliveryDays Int?
  maxDeliveryDays Int?
  isActive        Boolean  @default(true)
  order           Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  orders          Order[]

  @@map("shipping_methods")
}

model PaymentMethod {
  id          String    @id @default(cuid())
  name        String
  code        String    @unique
  description String?
  icon        String?
  isActive    Boolean   @default(true)
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  payments    Payment[]

  @@map("payment_methods")
}

model Payment {
  id              String        @id @default(cuid())
  orderId         String
  methodId        String
  amount          Decimal       @db.Decimal(10, 2)
  status          PaymentStatus @default(PENDING)
  transactionId   String?
  gatewayResponse Json?
  paidAt          DateTime?
  refundedAt      DateTime?
  refundAmount    Decimal?      @db.Decimal(10, 2)
  refundReason    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  method          PaymentMethod @relation(fields: [methodId], references: [id])
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model SalesMetric {
  id             String   @id @default(cuid())
  date           DateTime @db.Date
  managerId      String?
  ordersCount    Int      @default(0)
  revenue        Decimal  @default(0) @db.Decimal(12, 2)
  avgOrderValue  Decimal  @default(0) @db.Decimal(10, 2)
  newCustomers   Int      @default(0)
  conversionRate Decimal  @default(0) @db.Decimal(5, 2)
  createdAt      DateTime @default(now())
  manager        User?    @relation(fields: [managerId], references: [id])

  @@unique([date, managerId])
  @@map("sales_metrics")
}

model MarketingChannel {
  id        String            @id @default(cuid())
  name      String
  code      String            @unique
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  metrics   MarketingMetric[]

  @@map("marketing_channels")
}

model MarketingMetric {
  id        String           @id @default(cuid())
  channelId String
  date      DateTime         @db.Date
  visits    Int              @default(0)
  leads     Int              @default(0)
  orders    Int              @default(0)
  revenue   Decimal          @default(0) @db.Decimal(12, 2)
  cost      Decimal          @default(0) @db.Decimal(10, 2)
  createdAt DateTime         @default(now())
  channel   MarketingChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, date])
  @@map("marketing_metrics")
}

model Category {
  id          String              @id @default(cuid())
  name        String
  slug        String              @unique
  description String?
  image       String?
  parentId    String?
  order       Int                 @default(0)
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  icon        String?
  parent      Category?           @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Cascade)
  children    Category[]          @relation("CategoryTree")
  attributes  CategoryAttribute[]
  products    Product[]

  @@map("categories")
}

model CategoryAttribute {
  id          String    @id @default(cuid())
  categoryId  String
  attributeId String
  isRequired  Boolean   @default(false)
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  attribute   Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, attributeId])
  @@map("category_attributes")
}

model Product {
  id               String             @id @default(cuid())
  name             String
  slug             String             @unique
  description      String?
  sku              String?            @unique
  price            Decimal            @db.Decimal(10, 2)
  comparePrice     Decimal?           @db.Decimal(10, 2)
  stock            Int                @default(0)
  isActive         Boolean            @default(true)
  isFeatured       Boolean            @default(false)
  isNew            Boolean            @default(false)
  isPartnerProduct Boolean            @default(false)
  partnerId        String?
  sortOrder        Int                @default(0)
  categoryId       String
  images           String[]
  attributes       Json?
  seoTitle         String?
  seoDescription   String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  barcode          String?
  costPrice        Decimal?           @db.Decimal(10, 2)
  height           Decimal?           @db.Decimal(8, 2)
  length           Decimal?           @db.Decimal(8, 2)
  manufacturerId   String?
  minStock         Int                @default(0)
  seoKeywords      String[]
  shortDescription String?
  weight           Decimal?           @db.Decimal(8, 3)
  width            Decimal?           @db.Decimal(8, 2)
  sizes            String[]
  openingSide      String[]
  cartItems        CartItem[]
  orderItems       OrderItem[]
  suppliers        ProductSupplier[]
  category         Category           @relation(fields: [categoryId], references: [id])
  manufacturer     Manufacturer?      @relation(fields: [manufacturerId], references: [id])
  partner          Partner?           @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  reviews          Review[]
  wishlist         WishlistItem[]
  compareItems     CompareItem[]
  components       ProductComponent[]
  cardVariants     ProductCardVariant[]

  @@map("products")
}

/// Схожие товары в одной карточке (до 5): отличаются ценой, размером, фото, наименованием, цветом, доп. опцией (как на Wildberries/Озон).
model ProductCardVariant {
  id          String     @id @default(cuid())
  productId   String
  name        String     // Наименование варианта
  price       Decimal    @db.Decimal(10, 2)
  image       String?    // URL или base64
  size        String?    // Размер
  color       String?    // Цвет
  extraOption String?    // Доп. опция
  sortOrder   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  product     Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems   CartItem[]

  @@map("product_card_variants")
}

model ProductComponent {
  id        String     @id @default(cuid())
  productId String
  name      String // Наименование: коробка, наличник, добор, притворная планка
  type      String // Конкретный тип комплектующей
  price     Decimal    @db.Decimal(10, 2) // Стоимость за 1 шт.
  image     String? // Иконка/изображение комплектующего (base64 или URL)
  stock     Int        @default(0)
  isActive  Boolean    @default(true)
  sortOrder Int        @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems CartItem[]

  @@map("product_components")
}

model Order {
  id                String          @id @default(cuid())
  userId            String
  status            OrderStatus     @default(PENDING)
  total             Decimal         @db.Decimal(10, 2)
  subtotal          Decimal         @db.Decimal(10, 2)
  tax               Decimal         @db.Decimal(10, 2)
  shippingAddressId String
  paymentStatus     PaymentStatus   @default(PENDING)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  adminNotes        String?
  cancelReason      String?
  cancelledAt       DateTime?
  customerNotes     String?
  deliveredAt       DateTime?
  discount          Decimal         @default(0) @db.Decimal(10, 2)
  orderNumber       String          @unique
  refundAmount      Decimal?        @db.Decimal(10, 2)
  refundReason      String?
  refundedAt        DateTime?
  shippedAt         DateTime?
  shippingCost      Decimal         @db.Decimal(10, 2)
  shippingMethodId  String?
  trackingNumber    String?
  items             OrderItem[]
  shippingAddress   Address         @relation(fields: [shippingAddressId], references: [id])
  shippingMethod    ShippingMethod? @relation(fields: [shippingMethodId], references: [id])
  user              User            @relation(fields: [userId], references: [id])
  payments          Payment[]

  @@map("orders")
}

model OrderItem {
  id             String   @id @default(cuid())
  orderId        String
  productId      String
  cardVariantId  String?  // Вариант из «схожих товаров в карточке» (для истории)
  quantity       Int
  price          Decimal  @db.Decimal(10, 2)
  size           String?
  openingSide    String?
  createdAt      DateTime @default(now())
  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product        Product  @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Address {
  id         String      @id @default(cuid())
  userId     String
  type       AddressType @default(SHIPPING)
  firstName  String
  lastName   String
  phone      String
  street     String
  city       String
  region     String?
  postalCode String
  country    String      @default("RU")
  isDefault  Boolean     @default(false)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders     Order[]

  @@map("addresses")
}

model CartItem {
  id             String               @id @default(cuid())
  userId         String
  productId      String?
  componentId    String?
  cardVariantId  String?              // Вариант из «схожих товаров в карточке»
  quantity       Float                // Float для поддержки половинок
  size           String?
  openingSide    String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  product        Product?             @relation(fields: [productId], references: [id], onDelete: Cascade)
  component      ProductComponent?    @relation(fields: [componentId], references: [id], onDelete: Cascade)
  cardVariant    ProductCardVariant?   @relation(fields: [cardVariantId], references: [id], onDelete: SetNull)
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, productId])
  @@index([userId, componentId])
  @@map("cart_items")
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("wishlist_items")
}

model CompareItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("compare_items")
}

model Review {
  id           String    @id @default(cuid())
  productId    String
  userId       String?
  userName     String
  userEmail    String?   // Для гостевых отзывов
  rating       Int       @db.SmallInt
  comment      String?   @db.Text
  adminReply   String?   @db.Text // Ответ администратора
  adminReplyAt DateTime? // Когда написан ответ
  isApproved   Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model UserCabinetBlock {
  id                    String   @id @default("main")
  showProfileSection    Boolean  @default(true) // Личные данные
  showOrdersSection     Boolean  @default(true) // Мои заказы
  showNotificationsSection Boolean @default(true) // Уведомления
  showNotificationHistory Boolean @default(true) // История уведомлений (только чтение)
  showPasswordSection   Boolean  @default(true) // Смена пароля
  showQuickLinks       Boolean  @default(true) // Быстрые ссылки
  updatedAt             DateTime @updatedAt

  @@map("user_cabinet_block")
}

model ReviewsBlock {
  id                 String   @id @default("main")
  enabled             Boolean  @default(true) // Включить отзывы и оценки
  showOnCards        Boolean  @default(true) // Показывать рейтинг на карточках товаров
  requirePurchase    Boolean  @default(false) // Только покупатели могут оставлять отзывы
  allowGuestReviews  Boolean  @default(true) // Разрешить гостям оставлять отзывы
  requireModeration  Boolean  @default(true) // Требовать модерацию перед публикацией
  updatedAt          DateTime @updatedAt

  @@map("reviews_block")
}

model NotificationSound {
  id        String   @id @default(cuid())
  name      String   // Название звука
  fileUrl   String   // URL файла (/uploads/notification-sounds/...)
  createdAt DateTime @default(now())

  @@map("notification_sounds")
}

model UserAdminNotificationOverride {
  id                     String   @id @default(cuid())
  userId                 String   @unique // Персональные настройки для пользователя (переопределяют роль)
  soundEnabled           Boolean  @default(true)
  soundVolume            Int      @default(70)
  soundType              String   @default("beep")
  customSoundUrl         String?
  desktopNotifications   Boolean  @default(false)
  checkIntervalSeconds   Int      @default(60)
  notifyOnReviews        Boolean  @default(true)
  notifyOnOrders         Boolean  @default(true)
  notifyOnSupportChat    Boolean  @default(true)
  notifyOnMeasurementForm Boolean  @default(true)
  notifyOnCallbackForm   Boolean  @default(true)
  updatedAt              DateTime @updatedAt
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_admin_notification_override")
}

model AdminNotificationsBlock {
  id                     String   @id @default(cuid())
  role                   String?  @unique // null = по умолчанию для всех, иначе роль (ADMIN, MODERATOR и т.д.)
  soundEnabled           Boolean  @default(true) // Звук при событиях
  soundVolume            Int      @default(70) // Громкость 0-100
  soundType              String   @default("beep") // beep, ding, chime, bell или custom
  customSoundUrl         String?  // URL загруженного звука (при soundType=custom)
  desktopNotifications   Boolean  @default(false) // Браузерные уведомления
  checkIntervalSeconds   Int      @default(60) // Интервал проверки (сек)
  notifyOnReviews        Boolean  @default(true) // Уведомления о новых отзывах
  notifyOnOrders         Boolean  @default(true) // Уведомления о новых заказах
  notifyOnSupportChat    Boolean  @default(true) // Уведомления о сообщениях в чате
  notifyOnMeasurementForm  Boolean @default(true) // Уведомления о записи на замер
  notifyOnCallbackForm     Boolean @default(true) // Уведомления о заказе обратного звонка
  updatedAt              DateTime @updatedAt

  @@map("admin_notifications_block")
}

model FormSubmission {
  id             String   @id @default(cuid())
  type           String   // "measurement" | "callback"
  name           String
  phone          String
  email          String?
  address        String?
  preferredDate  String?
  preferredTime  String
  productType    String?
  comment        String?  @db.Text
  createdAt      DateTime @default(now())

  @@map("form_submissions")
}

// --- CRM: Направления ---
model CrmDirection {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  isActive     Boolean  @default(true)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  measurements Measurement[]
  contracts    Contract[]

  @@map("crm_directions")
}

// --- CRM: Замеры ---
model Measurement {
  id               String            @id @default(cuid())
  managerId        String
  receptionDate    DateTime          @db.Date
  executionDate    DateTime?         @db.Date
  surveyorId       String?
  directionId      String?
  customerName     String
  customerAddress  String?           @db.Text
  customerPhone    String
  comments         String?           @db.Text
  status           MeasurementStatus @default(NEW)
  customerId       String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  manager    User          @relation("MeasurementManager", fields: [managerId], references: [id], onDelete: Restrict)
  surveyor   User?         @relation("MeasurementSurveyor", fields: [surveyorId], references: [id], onDelete: SetNull)
  direction  CrmDirection? @relation(fields: [directionId], references: [id], onDelete: SetNull)
  customer   Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  contract   Contract?     @relation("MeasurementToContract")
  history    MeasurementHistory[]

  @@index([managerId])
  @@index([status])
  @@index([receptionDate])
  @@map("measurements")
}

model MeasurementHistory {
  id             String   @id @default(cuid())
  measurementId  String
  snapshot       Json     // Полное состояние замера до изменения
  changedFields  String[] @default([]) // Список изменённых полей для UPDATE
  action         String   // UPDATE | ROLLBACK
  changedById    String
  changedAt      DateTime @default(now())

  measurement  Measurement @relation(fields: [measurementId], references: [id], onDelete: Cascade)
  changedBy    User        @relation("MeasurementHistoryChangedBy", fields: [changedById], references: [id], onDelete: Restrict)

  @@index([measurementId])
  @@index([changedAt])
  @@map("measurement_history")
}

// --- CRM: Договоры ---
model Contract {
  id                   String         @id @default(cuid())
  contractNumber       String         @unique
  contractDate         DateTime       @db.Date
  status               ContractStatus @default(DRAFT)
  directionId          String?
  managerId            String?
  deliveryId           String?
  surveyorId           String?
  validityStart        DateTime?      @db.Date
  validityEnd          DateTime?      @db.Date
  contractDurationDays Int?           // Срок договора (число дней)
  contractDurationType String?       // CALENDAR | WORKING — календарные или рабочие дни
  installationDate     DateTime?      @db.Date
  installationDurationDays Int?      // Продолжительность монтажа в днях
  deliveryDate         DateTime?      @db.Date
  customerName         String
  customerAddress      String?        @db.Text
  customerPhone        String?
  customerId           String?
  discount             Decimal        @default(0) @db.Decimal(12, 2)
  totalAmount          Decimal        @db.Decimal(12, 2)
  advanceAmount        Decimal        @default(0) @db.Decimal(12, 2)
  notes                String?        @db.Text
  source               String?
  preferredExecutorId  String?
  measurementId        String?        @unique
  actWorkStartDate     DateTime?      @db.Date
  actWorkEndDate       DateTime?      @db.Date
  actWorkStartImages   String[]       @default([])
  actWorkEndImages     String[]       @default([])
  goodsTransferDate    DateTime?      @db.Date
  installers           String[]       @default([])
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  direction    CrmDirection?     @relation(fields: [directionId], references: [id], onDelete: SetNull)
  manager      User?             @relation("ContractManager", fields: [managerId], references: [id], onDelete: SetNull)
  surveyor     User?             @relation("ContractSurveyor", fields: [surveyorId], references: [id], onDelete: SetNull)
  customer     Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull)
  measurement  Measurement?      @relation("MeasurementToContract", fields: [measurementId], references: [id], onDelete: SetNull)
  advances     ContractAdvance[]
  amendments   ContractAmendment[]
  payments     ContractPayment[]
  history      ContractHistory[]

  @@index([managerId])
  @@index([status])
  @@index([contractDate])
  @@map("contracts")
}

model ContractHistory {
  id            String   @id @default(cuid())
  contractId    String
  snapshot      Json     // Состояние договора до изменения
  changedFields String[] @default([])
  action        String   // UPDATE | ROLLBACK
  changedById   String
  changedAt     DateTime @default(now())

  contract  Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  changedBy User     @relation("ContractHistoryChangedBy", fields: [changedById], references: [id], onDelete: Restrict)

  @@index([contractId])
  @@index([changedAt])
  @@map("contract_history")
}

model ContractAdvance {
  id         String   @id @default(cuid())
  contractId String
  amount     Decimal  @db.Decimal(12, 2)
  paidAt     DateTime @db.Date
  notes      String?  @db.Text
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@map("contract_advances")
}

model ContractAmendment {
  id                    String    @id @default(cuid())
  contractId            String
  number                Int?      // Номер д/с по порядку (1, 2, 3...)
  amount                Decimal   @db.Decimal(12, 2)  // изменение стоимости: +, -, 0
  discount              Decimal   @default(0) @db.Decimal(12, 2)  // скидка по д/с
  date                  DateTime  @db.Date
  extendsValidityTo     DateTime? @db.Date            // deprecated, см. durationAdditionDays
  durationAdditionDays  Int?      // дней к сроку договора (0/null = без изменений)
  durationAdditionType  String?   // CALENDAR | WORKING
  notes                 String?   @db.Text
  contract              Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@map("contract_amendments")
}

model ContractPayment {
  id          String       @id @default(cuid())
  contractId  String
  paymentDate DateTime     @db.Date
  amount      Decimal      @db.Decimal(12, 2)
  paymentForm PaymentForm
  paymentType PaymentType
  managerId   String?
  notes       String?      @db.Text
  createdAt   DateTime     @default(now())

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  manager  User?    @relation(fields: [managerId], references: [id], onDelete: SetNull)

  @@index([contractId])
  @@index([paymentDate])
  @@map("contract_payments")
}

enum MeasurementStatus {
  NEW
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  CONVERTED
}

enum ContractStatus {
  DRAFT
  ACTIVE
  IN_PROGRESS
  COMPLETED
  EXPIRED
  CANCELLED
}

enum PaymentForm {
  CASH
  TERMINAL
  QR
  INVOICE
}

enum PaymentType {
  PREPAYMENT
  ADVANCE
  FINAL
  AMENDMENT
}

enum ConversationStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  CONTENT_MANAGER
  MODERATOR
  SUPPORT
  PARTNER
  BRIGADIER
  LEAD_SPECIALIST_FURNITURE
  LEAD_SPECIALIST_WINDOWS_DOORS
  SURVEYOR
  DRIVER
  INSTALLER
  USER
  GUEST
}

enum LeadSource {
  WEBSITE
  PHONE
  EMAIL
  REFERRAL
  SOCIAL
  ADVERTISING
  EXHIBITION
  OTHER
}

enum CustomerStatus {
  LEAD
  PROSPECT
  CUSTOMER
  INACTIVE
  CHURNED
}

enum DealStage {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum InteractionType {
  CALL
  EMAIL
  MEETING
  NOTE
  TASK
  ORDER
}

enum TaskType {
  TODO
  CALL
  EMAIL
  MEETING
  FOLLOW_UP
  REMINDER
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CommentStatus {
  PENDING
  APPROVED
  SPAM
  REJECTED
}

enum AttributeType {
  TEXT
  NUMBER
  BOOLEAN
  SELECT
  MULTI_SELECT
  COLOR
}

enum SyncStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum AddressType {
  SHIPPING
  BILLING
}
